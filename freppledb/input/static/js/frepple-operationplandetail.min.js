/* frePPLe 4.0.0
Copyright (C) 2010-2019 by frePPLe bv

This library is free software; you can redistribute it and/or modify it
under the terms of the GNU Affero General Public License as published
by the Free Software Foundation; either version 3 of the License, or
(at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

angular.module("calendar",[]).constant("calendarConfig",{formatDay:"d",formatDayHeader:"EEE",formatDayTitle:"MMMM dd, yyyy",formatWeekTitle:"MMMM yyyy, Week w",formatMonthTitle:"MMMM yyyy",formatWeekViewDayHeader:"EEE d",formatHourColumn:"ha",showWeeks:!0}).controller("calendarController",["$scope","$attrs","$parse","$interpolate","$log","dateFilter","gettextCatalog","calendarConfig","PreferenceSvc",function(e,t,a,n,r,o,i,d,l){"use strict";var s=this,p={$setViewValue:angular.noop};angular.forEach(["formatDay","formatDayHeader","formatDayTitle","formatWeekTitle","formatMonthTitle","formatWeekViewDayHeader","formatHourColumn"],function(a,r){s[a]=angular.isDefined(t[a])?n(t[a])(e.$parent):d[a]}),angular.forEach(["showWeeks"],function(a,n){s[a]=angular.isDefined(t[a])?e.$parent.$eval(t[a]):d[a]}),s.hourParts=3600;var u=e.$parent.$watch(t.eventSource,function(e){s.onEventSourceChanged(e)});e.$on("$destroy",u),e.admin_escape=admin_escape,e.url_prefix=url_prefix,e.scrollBarWidth=getScrollBarWidth(),e.calendarmode=calendarmode,e.grouping=grouping,e.groupingdir=groupingdir,e.grid=grid,e.groupingcfg=groupingcfg,e.calendarmodes={start:i.getString("View start events"),end:i.getString("View end events"),start_end:i.getString("View start and end events"),duration:i.getString("View full duration")},e.setCalendarMode=function(t){e.calendarmode=t,l.save("calendarmode",t)},e.setGrouping=function(t){e.grouping=t,l.save("grouping",t),s._onDataLoaded()},e.setGroupingDir=function(t){e.groupingdir=t,l.save("groupingdir",t),s._onDataLoaded()},angular.isDefined(t.initDate)&&(s.currentCalendarDate=e.$parent.$eval(t.initDate)),s.currentCalendarDate||(s.currentCalendarDate=currentdate,t.ngModel&&!e.$parent.$eval(t.ngModel)&&a(t.ngModel).assign(e.$parent,s.currentCalendarDate)),e.getHeight=function(e){return preferences&&preferences.height?preferences.height-e:220-e},e.displayEvent=function(t,a){switch(e.calendarmode){case"duration":return!0;case"start_end":return moment(t.operationplan__startdate||t.startdate||t.operationplan__enddate||t.enddate).isSame(a.date,"day")||moment(t.operationplan__enddate||t.enddate||t.operationplan__startdate||t.startdate).isSame(a.date,"day");case"start":return moment(t.operationplan__startdate||t.startdate||t.operationplan__enddate||t.enddate).isSame(a.date,"day");case"end":return moment(t.operationplan__enddate||t.enddate||t.operationplan__startdate||t.startdate).isSame(a.date,"day")}},e.isStart=function(e,t){var a=e.startdate||e.operationplan__startdate;return!!a&&(t instanceof Date?a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()&&a.getDate()===t.getDate():moment(a).isSame(t.date,"day"))},e.isEnd=function(e,t){var a=e.enddate||e.operationplan__enddate;return!!a&&(a>(e.startdate||e.operationplan__startdate)&&(a=new Date(a-1)),t instanceof Date?a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()&&a.getDate()===t.getDate():moment(a).isSame(t.date,"day"))},e.displayEvent=function(t,a){switch(e.calendarmode){case"duration":return!0;case"start_end":return!!t.startdate&&moment(t.startdate).isSame(a.date,"day")||!!t.enddate&&moment(t.enddate>t.startdate?t.enddate-1:t.enddate).isSame(a.date,"day");case"start":return!!t.startdate&&moment(t.startdate).isSame(a.date,"day");case"end":return!!t.enddate&&moment(t.enddate>t.startdate?t.enddate-1:t.enddate).isSame(a.date,"day")}},s.init=function(e){(p=e).$render=function(){s.render()}},s.render=function(){if(p.$modelValue){var e=new Date(p.$modelValue),t=!isNaN(e);t?this.currentCalendarDate=e:r.error('"ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),p.$setValidity("date",t)}this.refreshView()},s.refreshView=function(){this.mode&&(this.range=this._getRange(this.currentCalendarDate),this._refreshView(),this.rangeChanged())},s.split=function(e,t){for(var a=[];e.length>0;)a.push(e.splice(0,t));return a},s.onEventSourceChanged=function(e){s.eventSource=e,s._onDataLoaded&&s._onDataLoaded()},e.move=function(t){var a,n=s.mode.step,r=s.currentCalendarDate,o=r.getFullYear()+t*(n.years||0),i=r.getMonth()+t*(n.months||0),d=r.getDate()+t*(n.days||0);r.setFullYear(o,i,d),"calendarmonth"===e.mode&&(a=new Date(o,i+1,1)).getTime()<=r.getTime()&&(s.currentCalendarDate=new Date(a-864e5)),p.$setViewValue(s.currentCalendarDate),s.refreshView()},s.move=function(t){e.move(t)},s.changeMode=function(t){e.mode=t},s.rangeChanged=function(){e.rangeChanged?e.rangeChanged({startdate:this.range.startdate,enddate:this.range.enddate}):console.error("No rangeChanged callback is registered")}}]).directive("calendar",function(){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/calendar.html",scope:{mode:"=",editable:"=",rangeChanged:"&",eventSelected:"&",timeSelected:"&"},require:["calendar","?^ngModel"],controller:"calendarController",link:function(e,t,a,n){var r,o=n[0],i=n[1];function d(t){var a=new Date(t.originalEvent.dataTransfer.getData("dragstart")),n=new Date($(t.target).closest(".datecell").attr("data-date")),o=t.originalEvent.dataTransfer.getData("dragreference"),i=t.originalEvent.dataTransfer.getData("dragrow"),d=$(t.target).closest("[data-row]").attr("data-row");if("resource"!==e.grouping||i!=d||a.getTime()!==n.getTime()){if("resource"!==e.grouping&&a.getTime()===n.getTime())return t.preventDefault(),void(d=i);e.$apply(function(){for(var t of e.$parent.calendarevents)if((t.id||t.reference)==o){var l=!1;if(e.isStart(t,a))t.hasOwnProperty("operationplan__startdate")?(e.changeCard(t,"operationplan__startdate",t.operationplan__startdate,n),t.operationplan__startdate=n,t.startdate=n,t.operationplan__enddate<n&&(t.operationplan__enddate=n),l=!0):t.hasOwnProperty("startdate")&&(e.changeCard(t,"startdate",t.startdate,n),t.startdate=n,t.enddate<n&&(t.enddate=n),l=!0);else if(e.isEnd(t,a))t.hasOwnProperty("operationplan__enddate")?(e.changeCard(t,"operationplan__enddate",t.operationplan__enddate,n),t.operationplan__enddate=n,t.enddate=n,t.operationplan__startdate>n&&(t.operationplan__startdate=n),l=!0):t.hasOwnProperty("enddate")&&(e.changeCard(t,"enddate",t.enddate,n),t.enddate=n,t.startdate>n&&(t.startdate=n),l=!0);else{var s=(n-a)/864e5;if(t.hasOwnProperty("operationplan__startdate"))(p=new Date(t.operationplan__startdate)).setDate(t.operationplan__startdate.getDate()+s),e.changeCard(t,"operationplan__startdate",t.operationplan__startdate,p),t.operationplan__startdate=p,t.startdate=p,t.operationplan__enddate<p&&(t.operationplan__enddate=n),l=!0;else if(t.hasOwnProperty("startdate")){var p;(p=new Date(t.startdate)).setDate(t.startdate.getDate()+s),e.changeCard(t,"startdate",t.startdate,p),t.startdate=p,t.enddate<p&&(t.enddate=p),l=!0}}i!=d&&t.resource==i&&(e.changeCard(t,"resource",t.row_dragstart,d),t.resource=d,l=!0),l&&r&&r(t,!0);break}}),t.preventDefault()}else t.preventDefault()}function l(e){e.originalEvent.dataTransfer.setData("dragstart",$(e.target).closest(".datecell").attr("data-date")),e.originalEvent.dataTransfer.setData("dragreference",$(e.target).closest(".card").attr("data-reference")),e.originalEvent.dataTransfer.setData("dragrow",$(e.target).closest("[data-row]").attr("data-row")),e.stopPropagation()}function s(e){e.preventDefault()}function p(){t.off("dragover","td.datecell",s),t.off("drop","td.datecell",d),t.off("dragstart",".card",l),r=null}e.curselected=null,i&&o.init(i),e.$on("selectedEdited",function(t,a,n,r){if(null!==e.curselected&&(!e.mode||e.mode.startsWith("calendar")))if("loadplans"==a){var o=[];angular.forEach(r,function(e){o.push([e.resource.name,e.quantity])}),e.changeCard(e.curselected,"resource",e.curselected.resource,o),e.curselected.resource=o}else e.changeCard(e.curselected,a,n),e.curselected[a]=r}),e.$on("changeDate",function(e,t){o.move(t)}),e.$on("eventSourceChanged",function(e,t){o.onEventSourceChanged(t)}),e.selectCard=function(t){if(e.curselected){if(e.curselected.reference==t.reference&&t.selected)return;delete e.curselected.selected}t.selected=!0,e.curselected=t,e.eventSelected({event:t})},e.changeCard=function(t,a,n,r){t.hasOwnProperty(a+"Original")||(t[a+"Original"]=n),t.dirty=!0,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),void 0!==r&&e.$parent.$broadcast("cardChanged",a,n,r)},e.enableDragDrop=function(e){p(),t.on("dragover","td.datecell",s),t.on("drop","td.datecell",d),t.on("dragstart",".card",l),r=e},e.disableDragDrop=p}}}).directive("monthview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/month.html",require:["^calendar","?^ngModel"],link:function(t,a,n,r){var o=r[0],i=r[1];function d(t,a){return{date:t,label:e(t,a),selected:0===o.compare(t,o.currentCalendarDate),current:0===o.compare(t,currentdate)}}function l(e,t){return(e.startdate?e.startdate:e.enddate).getTime()-(t.startdate?t.startdate:t.enddate)}function s(e,a){var n,r,i,d,l=e.startdate?new Date(e.startdate):null,s=e.enddate?new Date(e.enddate):null;if((s||l)<=o.range.startdate||(l||s)>=o.range.enddate)return!1;n=o.range.startdate,r=o.range.enddate,s||(s=l),l||(l=s),i=l<=n?0:(l-n-6e4*(l.getTimezoneOffset()-n.getTimezoneOffset()))/864e5,d=s>=r?(r-n-6e4*(r.getTimezoneOffset()-n.getTimezoneOffset()))/864e5:(s-n-6e4*(s.getTimezoneOffset()-n.getTimezoneOffset()))/864e5;for(var p,u=Math.floor(i),c=u-1;a&&c>=0;){var m=Math.floor(c/7),g=Math.floor(c%7),f=!1;if(p=t.rows[m][g].events)for(var h=p.length-1;h>=0;h--)if((e.id||e.reference)==(p[h].id||p[h].reference)){p.splice(h,1),f=!0;break}if(!f)break;c-=1}for(var v=!0;v||u<d;){v=!1;m=Math.floor(u/7),g=Math.floor(u%7);if(p=t.rows[m][g].events){f=!1;if(a)for(var h of p)if((e.id||e.reference)==(h.id||h.reference)){f=!0;break}f||p.push(e)}else(p=[]).push(e),t.rows[m][g].events=p;u+=1}for(;a;){m=Math.floor(u/7),g=Math.floor(u%7);if(m>=t.rows.length||g>=t.rows[m].length)break;f=!1;if(p=t.rows[m][g].events)for(h=p.length-1;h>=0;h--)if((e.id||e.reference)==(p[h].id||p[h].reference)){p.splice(h,1),f=!0;break}if(!f)break;u+=1}return!0}function p(e){var t=new Date(e.getFullYear(),0,1).getDay(),a=new Date(e.getFullYear(),0,(t<=4?5:12)-t),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+(4-e.getDay()))-a;return 1+Math.round(n/6048e5)}t.showWeeks=o.showWeeks,o.mode={step:{months:1}},t.select=function(e){var a=t.rows,n=e.date,r=e.events;if(a){var d=o.currentCalendarDate,l=d.getMonth(),s=d.getFullYear(),p=n.getMonth(),u=n.getFullYear(),c=0;if(s===u?l!==p&&(c=l<p?1:-1):c=s<u?1:-1,o.currentCalendarDate=n,i&&i.$setViewValue(n),0===c)for(var m=0;m<6;m+=1)for(var g=0;g<7;g+=1){var f=0===o.compare(n,a[m][g].date);a[m][g].selected=f,f&&(t.selectedDate=a[m][g])}else o.refreshView();t.timeSelected&&t.timeSelected({selectedTime:n,events:r})}},o._refreshView=function(){for(var a=o.range.startdate,n=a.getDate(),r=(a.getMonth()+(1!==n?1:0))%12,i=a.getFullYear()+(1!==n&&0===r?1:0),l=function(e,t){var a=new Array(t),n=new Date(e),r=0;for(n.setHours(12);r<t;)a[r++]=new Date(n),n.setDate(n.getDate()+1);return a}(a,42),s=0;s<42;s++)l[s]=angular.extend(d(l[s],o.formatDay),{secondary:l[s].getMonth()!==r});t.labels=new Array(7);for(var u=0;u<7;u++)t.labels[u]=e(l[u].date,o.formatDayHeader);var c=new Date(i,r,1);if(t.$parent.title=e(c,o.formatMonthTitle),t.rows=o.split(l,7),t.showWeeks){t.weekNumbers=[];for(var m=t.rows.length,g=0;g<m;g++)t.weekNumbers.push(p(t.rows[g][3].date))}},o._onDataLoaded=function(){var e,a,n=o.eventSource,r=n?n.length:0,i=t.rows,d=[];for(e=0;e<6;e+=1)for(a=0;a<7;a+=1)i[e][a].events=null;for(var p=0;p<r;p+=1){var u=n[p];s(u,!1)&&t.grouping&&!d.includes(u[t.grouping])&&d.push(u[t.grouping])}for(e=0;e<6;e+=1)for(a=0;a<7;a+=1)i[e][a].events&&i[e][a].events.sort(l);var c=!1;for(e=0;e<6;e+=1){for(a=0;a<7;a+=1)if(i[e][a].selected){t.selectedDate=i[e][a],c=!0;break}if(c)break}t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=d.sort().reverse():t.categories=d.sort():t.categories=["dummy"]},t.$on("changeMode",function(e,a){o.changeMode(a),t.editable&&"calendarmonth"==a?t.enableDragDrop(s):t.disableDragDrop()}),o.compare=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate())-new Date(t.getFullYear(),t.getMonth(),t.getDate())},o._getRange=function(e){var t,a=e.getFullYear(),n=e.getMonth(),r=new Date(a,n,1),o=1-r.getDay(),i=o>0?7-o:-o,d=new Date(r);return i>0&&d.setDate(1-i),(t=new Date(d)).setDate(t.getDate()+42),{startdate:d,enddate:t}},o.refreshView(),t.editable&&"calendarmonth"==t.mode&&t.enableDragDrop(s)}}}]).directive("weekview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/week.html",require:"^calendar",link:function(t,a,n,r){function o(e,a){var n,o,i=e.startdate?new Date(e.startdate):null,d=e.enddate?new Date(e.enddate):null;if((d||i)<=r.range.startdate||(i||d)>=r.range.enddate)return!1;d||(d=i),i||(i=d),n=i<=r.range.startdate?0:(i-r.range.startdate-6e4*(i.getTimezoneOffset()-r.range.startdate.getTimezoneOffset()))/36e5,o=d>=r.range.enddate?(r.range.enddate-r.range.startdate-6e4*(r.range.enddate.getTimezoneOffset()-r.range.startdate.getTimezoneOffset()))/36e5:(d-r.range.startdate-6e4*(d.getTimezoneOffset()-r.range.startdate.getTimezoneOffset()))/36e5;for(var l=Math.floor(n),s=Math.ceil((o-.016)/24),p=Math.floor(l/24),u=p-1;a&&u>=0;){var c=!1,m=t.dates[u].events;if(m)for(var g=m.length-1;g>=0;g--)if((e.id||e.reference)==(m[g].id||m[g].reference)){m.splice(g,1),c=!0;break}if(!c)break;u-=1}do{if(t.dates[p].events){c=!1;if(a)for(var g of t.dates[p].events)if((e.id||e.reference)==(g.id||g.reference)){c=!0;break}c||t.dates[p].events.push(e)}else t.dates[p].events=[e];p+=1}while(p<s);for(;a&&p<7;){c=!1;if(m=t.dates[p].events)for(g=m.length-1;g>=0;g--)if((e.id||e.reference)==(m[g].id||m[g].reference)){m.splice(g,1),c=!0;break}if(!c)break;p+=1}return!0}t.formatWeekViewDayHeader=r.formatWeekViewDayHeader,t.formatHourColumn=r.formatHourColumn,r.mode={step:{days:7}},t.hourParts=r.hourParts,t.select=function(e,a){t.timeSelected&&t.timeSelected({selectedTime:e,events:a})},r._onDataLoaded=function(){var e,a=r.eventSource,n=a?a.length:0,i=t.dates,d=[];for(e=0;e<7;e+=1)i[e].events&&(i[e].events=null);for(var l=0;l<n;l+=1){var s=a[l];o(s,!1)&&t.grouping&&!d.includes(s[t.grouping])&&d.push(s[t.grouping])}t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=d.sort().reverse():t.categories=d.sort():t.categories=["dummy"]},t.$on("changeMode",function(e,a){r.changeMode(a),t.editable&&"calendarweek"==a?t.enableDragDrop(o):t.disableDragDrop()}),r._refreshView=function(){var a,n;t.dates=function(e,t){var a=new Array(t),n=new Date(e),r=0;for(n.setHours(12);r<t;)a[r++]={date:new Date(n)},n.setDate(n.getDate()+1);return a}(r.range.startdate,7),a=r.formatWeekTitle.indexOf("w"),n=e(r.range.startdate,r.formatWeekTitle),-1!==a&&(n=n.replace("w",function(e){var t=new Date(e);t.setDate(t.getDate()+4-(t.getDay()||7));var a=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((a-t)/864e5)/7)+1}(r.range.startdate))),t.$parent.title=n},r._getRange=function(e){var t=e.getFullYear(),a=e.getMonth(),n=e.getDate(),r=e.getDay();return{startdate:new Date(t,a,n-r),enddate:new Date(t,a,n-r+7)}},r.refreshView(),t.editable&&"calendarweek"==t.mode&&t.enableDragDrop(o)}}}]).directive("dayview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/day.html",require:"^calendar",link:function(t,a,n,r){function o(e,t){}t.formatHourColumn=r.formatHourColumn,r.mode={step:{days:1}},t.hourParts=r.hourParts,t.events=[],t.select=function(e,a){t.timeSelected&&t.timeSelected({selectedTime:e,events:a})},t.$on("changeMode",function(e,a){r.changeMode(a),t.editable&&"calendarday"==a?t.enableDragDrop(o):t.disableDragDrop()}),r._onDataLoaded=function(){var e=r.eventSource,a=e?e.length:0,n=r.range.startdate,o=r.range.enddate,i=[];t.events=null;for(var d=0;d<a;d+=1){var l=e[d],s=l.startdate?new Date(l.startdate):null,p=l.enddate?new Date(l.enddate):null;(p||s)<=n||(s||p)>=o||(t.events?t.events.push(l):t.events=[l],t.grouping&&!i.includes(l[t.grouping])&&i.push(l[t.grouping]))}t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=i.sort().reverse():t.categories=i.sort():t.categories=["dummy"]},r._refreshView=function(){var a=r.range.startdate;t.rows=function(e){for(var a,n=[],r=e.getHours(),o=e.getDate(),i=0;i<24;i+=1)(a=new Date(e.getTime())).setHours(r+i),a.setDate(o),n.push({date:a});return t.dt={date:e},n}(a),t.dates=[a],t.$parent.title=e(a,r.formatDayTitle)},r._getRange=function(e){var t=e.getFullYear(),a=e.getMonth(),n=e.getDate();return{startdate:new Date(t,a,n),enddate:new Date(t,a,n+1)}},r.refreshView(),t.editable&&"calendarday"==t.mode&&t.enableDragDrop(o)}}}]);var operationplandetailapp=angular.module("operationplandetailapp",["ngCookies","gettext","ngWebSocket","frepple.input","frepple.common","calendar"],["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1})}]);function operationplanCtrl(e,t,a,n){function r(e){if(void 0===e.color||""===e.color)return[void 0,""];var t=parseInt(e.color);if(e.inventory_item||e.leadtime){if(!isNaN(t))return t>=100&&t<999999?["rgba(0,128,0,0.5)",Math.round(e.computed_color)+"%"]:0===t?["rgba(255,0,0,0.5)",Math.round(e.computed_color)+"%"]:999999===t?[void 0,""]:["rgba(255,"+Math.round(t/100*255)+",0,0.5)",Math.round(e.computed_color)+"%"]}else{var a=Math.round(parseInt(e.delay)/8640)/10;if(isNaN(a)&&(a=Math.round(parseInt(e.operationplan__delay)/8640)/10),999===parseInt(e.criticality)||999===parseInt(e.operationplan__criticality))return[void 0,""];if(a<0)return["rgba(0,128,0,0.5)",-a+" "+gettext("days early")];if(0===a)return["rgba(0,128,0,0.5)",gettext("on time")];if(a>0)return t>100||t<0?["rgba(255,0,0,0.5)",a+" "+gettext("days late")]:["rgba(255,"+Math.round(t/100*255)+",0,0.5)",a+" "+gettext("days late")]}return[void 0,""]}function o(a){if(!a){var n=$("#grid").getGridParam("postData");a=n&&n.filters?JSON.parse(n.filters):initialfilter}var o=$("#grid").getGridParam("sortname"),i="";""!==o&&(i="&sidx="+encodeURIComponent(o)+"&sord="+encodeURIComponent($("#grid").getGridParam("sortorder")));var d=(-1!=location.href.indexOf("#")?location.href.substr(0,location.href.indexOf("#")):location.href)+(location.search.length>0?"&format=calendar":"?format=calendar")+"&calendarstart="+moment(e.calendarStart).format("YYYY-MM-DD%20HH:MM:SS")+"&calendarend="+moment(e.calendarEnd).format("YYYY-MM-DD%20HH:MM:SS")+i;t.get(d+"&filters="+encodeURIComponent(JSON.stringify(a))).then(function(t){var a=angular.copy(t.data);for(var n of a.rows)n.type=n.operationplan__type||n.type||default_operationplan_type,n.hasOwnProperty("enddate")&&(n.enddate=new Date(n.enddate)),n.hasOwnProperty("operationplan__enddate")&&(n.operationplan__enddate=new Date(n.operationplan__enddate),n.enddate=n.operationplan__enddate),n.hasOwnProperty("startdate")&&(n.startdate=new Date(n.startdate)),n.hasOwnProperty("operationplan__startdate")&&(n.operationplan__startdate=new Date(n.operationplan__startdate),n.startdate=n.operationplan__startdate),n.hasOwnProperty("quantity")&&(n.quantity=parseFloat(n.quantity)),n.hasOwnProperty("operationplan__quantity")&&(n.operationplan__quantity=parseFloat(n.operationplan__quantity)),n.hasOwnProperty("quantity_completed")&&(n.quantity_completed=parseFloat(n.quantity_completed)),n.hasOwnProperty("operationplan__quantity_completed")&&(n.operationplan__quantity_completed=parseFloat(n.operationplan__quantity_completed)),n.hasOwnProperty("operationplan__status")&&(n.status=n.operationplan__status),n.hasOwnProperty("operationplan__origin")&&(n.origin=n.operationplan__origin),[n.color,n.inventory_status]=r(n);e.calendarevents=a.rows,e.totalevents=a.records},function(e){401==e.status&&location.reload()})}e.operationplan=new a,e.aggregatedopplan=null,e.mode=preferences?preferences.mode:"table",e.detailposition=detailposition,e.operationplans=[],e.kanbanoperationplans={},e.colsum=12,e.kanbancolumns=preferences?preferences.columns:void 0,e.kanbancolumns||(e.kanbancolumns=["proposed","approved","confirmed","completed","closed"]),e.groupBy=preferences?preferences.groupBy:void 0,e.groupBy||("undefined"!=typeof groupBy?e.groupBy=groupBy:e.groupBy="status"),e.groupOperator=preferences?preferences.groupOperator:void 0,e.groupOperator||(e.groupOperator="eq"),e.displayongrid=displayongrid,"function"==typeof e.displayongrid&&e.$watchGroup(["operationplan.id","operationplan.start","operationplan.end","operationplan.quantity","operationplan.status","operationplan.quantity_completed","operationplan.remark","operationplan.loadplans","operationplan.resource"],function(t,a){a[0]===t[0]&&-1!==t[0]&&void 0!==a[0]&&(void 0!==a[1]&&void 0!==t[1]&&a[1]!==t[1]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","startdate",a[1],new Date(e.operationplan.start)):e.displayongrid(e.operationplan.id,"startdate",e.operationplan.start)),void 0!==a[2]&&void 0!==t[2]&&a[2]!==t[2]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","enddate",a[2],new Date(e.operationplan.end)):e.displayongrid(e.operationplan.id,"enddate",e.operationplan.end)),void 0!==a[3]&&void 0!==t[3]&&a[3]!==t[3]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","quantity",a[3],e.operationplan.quantity):e.displayongrid(e.operationplan.id,"quantity",e.operationplan.quantity)),void 0!==a[4]&&void 0!==t[4]&&a[4]!==t[4]&&(actions.hasOwnProperty(e.operationplan.status)?"kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","status",a[4],e.operationplan.status):e.displayongrid(e.operationplan.id,"status",e.operationplan.status):actions[Object.keys(actions)[0]]()),void 0!==a[5]&&void 0!==t[5]&&a[5]!==t[5]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","quantity_completed",a[5],e.operationplan.quantity_completed):e.displayongrid(e.operationplan.id,"quantity_completed",e.operationplan.quantity_completed)),void 0!==a[6]&&void 0!==t[6]&&a[6]!==t[6]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","remark",a[6],e.operationplan.remark):e.displayongrid(e.operationplan.id,"remark",e.operationplan.remark))),a[0]=t[0]}),e.processAggregatedInfo=function(t,n){var r=[],o={colmodel:{}},i=0;angular.forEach(n,function(e,t){e.hasOwnProperty("summaryType")&&(r.push([t,e.name,e.summaryType,e.formatter]),o[e.name]=null,o.colmodel[e.name]={type:e.summaryType,label:e.label,formatter:e.formatter})}),angular.forEach(t,function(e){angular.forEach(r,function(t){"sum"===t[2]?isNaN(parseFloat(e[t[1]]))||(null===o[t[1]]?o[t[1]]=parseFloat(e[t[1]]):o[t[1]]+=parseFloat(e[t[1]])):"max"===t[2]?-1!==["color","number","currency"].indexOf(t[3])&&""!==e[t[1]]?parseFloat(e[t[1]])&&(null===o[t[1]]?o[t[1]]=parseFloat(e[t[1]]):o[t[1]]=Math.max(o[t[1]],parseFloat(e[t[1]]))):"duration"===t[3]?"Invalid Date"!==(i=new moment.duration(e[t[1]]).asSeconds())._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.max(o[t[1]],i)):"date"===t[3]&&"Invalid Date"!==(i=new moment(e[t[1]],datetimeformat))._d&&(null===o[t[1]]||i.isAfter(o[t[1]]))&&(o[t[1]]=i):"min"===t[2]&&(-1!==["color","number"].indexOf(t[3])&&""!==e[t[1]]?(i=parseFloat(e[t[1]]),isNaN(i)||(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.min(o[t[1]],i))):"duration"===t[3]?"Invalid Date"!==(i=new moment.duration(e[t[1]]).asSeconds())._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.min(o[t[1]],i)):"date"===t[3]&&"Invalid Date"!==(i=new moment(e[t[1]],datetimeformat))._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=moment.min(o[t[1]],i)))})}),e.operationplan=new a,o.start=o.startdate,o.end=o.enddate,o.id=-1,o.count=t.length,o.type=t[0].type,e.$apply(function(){e.operationplan.extend(o)})},e.$on("updateCard",function(t,a,n,r){e.$apply(function(){e.$broadcast("selectedEdited",a,n,r)})}),e.displayInfo=function(t){if("kanban"!=e.mode||void 0!==t)if(e.mode.startsWith("calendar")&&void 0===t)e.loadCalendarData();else{var n=void 0;void 0!==t&&(n=t.hasOwnProperty("operationplan__reference")?t.operationplan__reference:t.reference),e.operationplan=new a,e.operationplan.id=n,void 0===e.operationplan.id?e.$apply(function(){e.operationplan=new a}):e.operationplan.get(function(e){if(void 0===t)return e;void 0!==t.operationplan__startdate&&""!==t.operationplan__startdate?e.start=t.operationplan__startdate:void 0!==t.startdate&&""!==t.startdate&&(e.start=t.startdate),void 0!==t.operationplan__enddate&&""!==t.operationplan__enddate?e.end=t.operationplan__enddate:void 0!==t.enddate&&""!==t.enddate&&(e.end=t.enddate),void 0!==t.operationplan__quantity&&""!==t.operationplan__quantity?e.quantity=parseFloat(t.operationplan__quantity):void 0!==t.quantity&&""!==t.quantity&&(e.quantity=parseFloat(t.quantity)),void 0!==t.operationplan__status&&""!==t.operationplan__status?e.status=t.operationplan__status:void 0!==t.status&&""!==t.status&&(e.status=t.status),void 0!==t.operationplan__quantity_completed&&""!==t.operationplan__quantity_completed?e.quantity_completed=parseFloat(t.operationplan__quantity_completed):void 0!==t.quantity_completed&&""!==t.quantity_completed&&(e.quantity_completed=parseFloat(t.quantity_completed)),void 0!==e.invstatus&&(e.invstatus.pipeline=0)})}else e.loadKanbanData()},e.refreshstatus=function(t){"no_action"!==t&&e.$apply(function(){e.operationplan.status=t})},e.setMode=function(t){function a(){n.save("mode",t),e.$apply(function(){e.mode=t}),angular.element("#controller").scope().$broadcast("changeMode",t),"kanban"==t?($("#gridmode, #calendarmode").removeClass("active"),$("#kanbanmode").addClass("active"),angular.element(document).find("#customize").hide(),mode="kanban",e.loadKanbanData()):t.startsWith("calendar")?($("#kanbanmode, #gridmode").removeClass("active"),$("#calendarmode").addClass("active"),angular.element(document).find("#customize").hide(),mode=t):($("#kanbanmode, #calendarmode").removeClass("active"),$("#gridmode").addClass("active"),mode="grid",angular.element(document).find("#grid").jqGrid("GridUnload"),initialfilter=thefilter,angular.element(document).find("#customize").show(),displayGrid(!0)),setHeights()}var r=angular.element(document).find("#save");return e.mode!=t&&r.hasClass("btn-danger")?($("#popup").html('<div class="modal-dialog"><div class="modal-content"><div class="modal-header alert-warning" style="border-top-left-radius: inherit; border-top-right-radius: inherit"><h4 class="modal-title">'+gettext("Save or cancel your changes first")+'</h4></div><div class="modal-body">'+gettext("There are unsaved changes on this page.")+'</div><div class="modal-footer"><input type="submit" id="savebutton" role="button" class="btn btn-danger pull-left" value="'+gettext("Save")+'"><input type="submit" id="cancelbutton" role="button" class="btn btn-primary pull-right" value="'+gettext("Return to page")+'"></div></div></div>').modal("show"),$("#savebutton").on("click",function(){r.trigger("click"),a(),$("#popup").modal("hide")}),$("#cancelbutton").on("click",function(){$("#popup").modal("hide")}),!1):(a(),!0)},e.displayonpanel=function(t,a,n){angular.element(document.getElementById(e.operationplan.id)).removeClass("edited").addClass("edited"),void 0!==e.operationplan.id&&t===e.operationplan.id.toString()&&("startdate"!==a&&"operationplan__startdate"!==a||e.$apply(function(){e.operationplan.start=n}),"enddate"!==a&&"operationplan__enddate"!==a||e.$apply(function(){e.operationplan.end=n}),"quantity"===a&&e.$apply(function(){e.operationplan.quantity=parseFloat(n)}),"status"===a&&e.refreshstatus(n),"quantity_completed"===a&&e.$apply(function(){e.operationplan.quantity_completed=parseFloat(n)}))},e.calendarevents=[],e.calendarStart=null,e.calendarEnd=null,e.mode=preferences&&preferences.mode||"table",e.calendarRangeChanged=function(t,a){e.calendarStart=t,e.calendarEnd=a,e.mode&&e.mode.startsWith("calendar")&&o()},e.loadCalendarData=o,e.loadKanbanData=function(a){if(!a){var n=$("#grid").getGridParam("postData");a=n&&n.filters?JSON.parse(n.filters):initialfilter}var o=$("#grid").getGridParam("sortname"),i="";""!==o&&(i="&sidx="+encodeURIComponent(o)+"&sord="+encodeURIComponent($("#grid").getGridParam("sortorder")));var d=(-1!=location.href.indexOf("#")?location.href.substr(0,location.href.indexOf("#")):location.href)+(location.search.length>0?"&format=kanban":"?format=kanban");angular.forEach(e.kanbancolumns,function(n){var o=angular.copy(a),l={field:e.groupBy,op:e.groupOperator,data:n};void 0===o||null===o?o={groupOp:"AND",rules:[l],groups:[]}:"AND"==o.groupOp?o.rules.push(l):o={groupOp:"AND",rules:[l],groups:[o]},t.get(d+"&filters="+encodeURIComponent(JSON.stringify(o))+i).then(function(t){var a=angular.copy(t.data);for(var o of a.rows)o.type=o.operationplan__type||o.type||default_operationplan_type,o.hasOwnProperty("enddate")&&(o.enddate=new Date(o.enddate)),o.hasOwnProperty("operationplan__enddate")&&(o.operationplan__enddate=new Date(o.operationplan__enddate)),o.hasOwnProperty("startdate")&&(o.startdate=new Date(o.startdate)),o.hasOwnProperty("operationplan__startdate")&&(o.operationplan__startdate=new Date(o.operationplan__startdate)),o.hasOwnProperty("quantity")&&(o.quantity=parseFloat(o.quantity)),o.hasOwnProperty("operationplan__quantity")&&(o.operationplan__quantity=parseFloat(o.operationplan__quantity)),o.hasOwnProperty("quantity_completed")&&(o.quantity_completed=parseFloat(o.quantity_completed)),o.hasOwnProperty("operationplan__quantity_completed")&&(o.operationplan__quantity_completed=parseFloat(o.operationplan__quantity_completed)),o.hasOwnProperty("operationplan__status")&&(o.status=o.operationplan__status),o.hasOwnProperty("operationplan__origin")&&(o.origin=o.operationplan__origin),[o.color,o.inventory_status]=r(o);e.kanbanoperationplans[n]=a},function(e){401==e.status&&location.reload()})})},e.getDirtyCards=function(){var t=[];return e.mode&&e.mode.startsWith("calendar")?angular.forEach(e.calendarevents,function(e){var a={id:e.id||e.reference},n=!1;for(var r in e.hasOwnProperty("operationplan__reference")&&(a.operationplan__reference=e.operationplan__reference),e)e.hasOwnProperty(r+"Original")&&(n=!0,e[r]instanceof Date?a[r]=new moment(e[r]).format("YYYY-MM-DD HH:mm:ss"):a[r]=e[r]);n&&t.push(a)}):"kanban"==e.mode&&angular.forEach(e.kanbanoperationplans,function(e,a){angular.forEach(e.rows,function(e){var a={id:e.id||e.reference},n=!1;for(var r in e.hasOwnProperty("operationplan__reference")&&(a.operationplan__reference=e.operationplan__reference),e)e.hasOwnProperty(r+"Original")&&(n=!0,e[r]instanceof Date?a[r]=new moment(e[r]).format("YYYY-MM-DD HH:mm:ss"):a[r]=e[r]);n&&t.push(a)})}),e.deleted&&e.deleted.length&&(t.push({delete:e.deleted}),e.deleted=[]),t!=[]&&(e.operationplan=void 0),t},preferences&&"kanban"==preferences.mode&&e.loadKanbanData()}function showproblemspanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("problems")+'</h4></div><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("start")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("end")+"</b></td></tr></thead><tbody></tbody></table>";e.$watchGroup(["operationplan.id","operationplan.problems.length"],function(a,n){angular.element(document).find("#attributes-operationproblems").empty().append(r);var o='<tr><td colspan="3">'+t.getString("no problems")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("problems")&&(o="",angular.forEach(e.operationplan.problems,function(e){o+="<tr><td>"+e.description+"</td><td>"+e.start+"</td><td>"+e.end+"</td></tr>"})),angular.element(document).find("#attributes-operationproblems tbody").append(o)})}}}function showresourcespanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data",mode:"=mode"},link:function(e,a,n){var r='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("resource")+'</h4></div><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+"</b></td><tbody></tbody></table>";e.$watchGroup(["operationplan.id","operationplan.loadplans.length"],function a(){angular.element(document).find("#attributes-operationresources").empty().append(r);var n='<tr><td colspan="2">'+t.getString("no resources")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("loadplans")&&(n="",angular.forEach(e.operationplan.loadplans,function(e){e.hasOwnProperty("alternates")?(n+='<tr><td style="white-space: nowrap;"><div class="dropdown dropdown-submit-input"><button class="btn btn-default" data-toggle="dropdown" type="button" style="text-transform: capitalize; min-width: 150px">'+$.jgrid.htmlEncode(e.resource.name)+'</button><ul class="dropdown-menu"><li><a role="menuitem" class="alternateresource" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e.resource.name)+"</a></li>",angular.forEach(e.alternates,function(e){n+='<li><a role="menuitem" class="alternateresource" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e.name)+"</a></li>"}),n+="</ul></td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"):n+="<tr><td>"+$.jgrid.htmlEncode(e.resource.name)+'<a href="'+url_prefix+"/detail/input/resource/"+admin_escape(e.resource.name)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"}));angular.element(document).find("#attributes-operationresources tbody").append(n);angular.element(document).find("#attributes-operationresources a.alternateresource").bind("click",function(){var t=$(this).html(),n=$(this).parent().parent().prev().html();t!=n&&angular.forEach(e.operationplan.loadplans,function(r){if(r.resource.name==n){if(r.resource.name=t,angular.forEach(r.alternates,function(e){e.name===t&&(e.name=n)}),a(),e.mode&&(e.mode.startsWith("calendar")||"kanban"==e.mode))e.$emit("updateCard","loadplans",e.operationplan.loadplansOriginal,e.operationplan.loadplans);else{var o=angular.element(document).find("#grid"),i=o.jqGrid("getGridParam","selarrrow"),d=o.jqGrid("getGridParam","colModel").find(function(e){return"resource"==e.name}),l=o.jqGrid("getCell",i,"resource");if("detail"==d.formatter&&l==n)o.jqGrid("setCell",i,"resource",t,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges);else if("listdetail"==d.formatter){var s=[];angular.forEach(e.operationplan.loadplans,function(e){s.push([e.resource.name,e.quantity])}),o.jqGrid("setCell",i,"resource",s,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges)}}return!1}})})})}}}function showbufferspanelDrv(e,t,a){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,n,r){var o='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("material")+'</h4></div><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("item")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("onhand")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("date")+"</b></td></tr></thead><tbody></tbody></table>";e.$watchGroup(["operationplan.id","operationplan.flowplans.length"],function n(){angular.element(document).find("#attributes-operationflowplans").empty().append(o);var r='<tr><td colspan="3">'+t.getString("no movements")+"<td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("flowplans")&&(r="",angular.forEach(e.operationplan.flowplans,function(e){r+="",e.hasOwnProperty("alternates")?(r+='<td style="white-space: nowrap"><div class="dropdown dropdown-submit-input"><button class="btn btn-default" data-toggle="dropdown" type="button" style="text-transform: capitalize; min-width: 150px">'+$.jgrid.htmlEncode(e.buffer.item)+'</button><ul class="dropdown-menu"><li><a role="menuitem" class="alternateitem" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e.buffer.item)+"</a></li>",angular.forEach(e.alternates,function(e){r+='<li><a role="menuitem" class="alternateitem" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e)+"</a></li>"}),r+="</ul></td>"):(r+="<tr><td><span ",e.buffer.description&&(r+=' onmouseenter="$(this).tooltip(\'show\')" title="'+$.jgrid.htmlEncode(e.buffer.description)+'"'),r+=">"+$.jgrid.htmlEncode(e.buffer.item)+'<a href="'+url_prefix+"/detail/input/item/"+admin_escape(e.buffer.item)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></span></td>"),r+="<td>"+grid.formatNumber(e.quantity)+"</td><td>"+grid.formatNumber(e.onhand)+'</td><td style="white-space: nowrap">'+a("formatdatetime")(e.date)+"</td></tr>"}),angular.element(document).find("#attributes-operationflowplans thead").css("display","table-header-group"));angular.element(document).find("#attributes-operationflowplans tbody").append(r);angular.element(document).find("#attributes-operationflowplans a.alternateitem").bind("click",function(){var t=$(this).html(),a=$(this).parent().parent().prev().html();t!=a&&angular.forEach(e.operationplan.flowplans,function(r){if(r.buffer.item==a){r.buffer.item=t,n();var o=angular.element(document).find("#grid"),i=o.jqGrid("getGridParam","selarrrow"),d=o.jqGrid("getGridParam","colModel").find(function(e){return"material"==e.name}),l=o.jqGrid("getCell",i,"material");if("detail"==d.formatter&&l==a)o.jqGrid("setCell",i,"material",t,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1);else if("listdetail"==d.formatter){var s=[];angular.forEach(e.operationplan.flowplans,function(e){s.push([e.buffer.item,e.quantity])}),o.jqGrid("setCell",i,"material",s,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1)}return!1}})})})}}}function showoperationpeggingpanelDrv(e,t,a){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,n,r,o){var i='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("demand")+'</h4></div><div class="panel-body table-responsive" style="max-height:15em; overflow:auto; padding:0"><table class="table table-condensed table-hover"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("item")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("due")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+"</b></td><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.pegging_demand.length"],function(n,r){angular.element(document).find("#attributes-operationdemandpegging").empty().append(i);var o='<tr><td colspan="2">'+t.getString("no demands")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("pegging_demand")&&(o="",angular.forEach(e.operationplan.pegging_demand,function(e){o+="<tr><td>"+$.jgrid.htmlEncode(e.demand.name)+'<a href="'+url_prefix+(e.demand.forecast?"/detail/forecast/forecast/":"/detail/input/demand/")+admin_escape(e.demand.name)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td><td>",e.demand.item.description?o+='<span onmouseenter="$(this).tooltip(\'show\')" title="'+$.jgrid.htmlEncode(e.demand.item.description)+'">'+$.jgrid.htmlEncode(e.demand.item.name)+"</span>":o+=$.jgrid.htmlEncode(e.demand.item.name),o+='<a href="'+url_prefix+"/detail/input/item/"+admin_escape(e.demand.item.name)+"/\" onclick='event.stopPropagation()'><span class='leftpadding fa fa-caret-right'></span></a></td><td>"+a("formatdate")(e.demand.due)+"</td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"})),angular.element(document).find("#attributes-operationdemandpegging tbody").append(o)})}}}function showoperationplanDrv(e,t){return{restrict:"EA",scope:!0,templateUrl:"/static/operationplandetail/operationplanpanel.html",link:function(e,a,n){e.actions=actions,e.opptype={MO:t.getString("manufacturing order"),PO:t.getString("purchase order"),DO:t.getString("distribution order"),STCK:t.getString("stock"),DLVR:t.getString("delivery")},e.$on("cardChanged",function(t,a,n,r){e.operationplan&&("startdate"===a?e.operationplan.start=r:"enddate"===a?e.operationplan.end=r:e.operationplan[a]=r)}),e.$watchGroup(["operationplan.id","operationplan.start","operationplan.end","operationplan.quantity","operationplan.completed_quantity","operationplan.criticality","operationplan.delay","operationplan.status","operationplan.remark"],function(t,n){void 0!==e.operationplan&&null!==e.operationplan&&(-1==e.operationplan.id||"STCK"===e.operationplan.type?(angular.element(a).find("input").attr("disabled","disabled"),angular.element(a).find("#statusrow .btn").removeClass("active").attr("disabled","disabled")):void 0!==e.operationplan.id?(angular.element(a).find("input[disabled]").attr("disabled",!1),"undefined"!=typeof actions&&actions.hasOwnProperty("proposed")&&angular.element(a).find("button[disabled]").attr("disabled",!1),angular.element(a).find("#statusrow .btn").removeClass("active"),e.operationplan.hasOwnProperty("start")&&angular.element(a).find("#setStart").val(moment.utc(e.operationplan.start,datetimeformat).format(datetimeformat)),e.operationplan.hasOwnProperty("end")&&angular.element(a).find("#setEnd").val(moment.utc(e.operationplan.end,datetimeformat).format(datetimeformat)),e.operationplan.hasOwnProperty("status")&&(angular.element(a).find("#statusrow .btn").removeClass("active"),angular.element(a).find("#"+e.operationplan.status+"Btn").addClass("active"))):(angular.element(a).find("input").attr("disabled","disabled"),angular.element(a).find("#statusrow .btn").removeClass("active").attr("disabled","disabled"),angular.element(a).find("#setStart").val(""),angular.element(a).find("#setEnd").val("")),angular.element(a).find("#statusrow").css("display",e.operationplan.status&&"STCK"!==e.operationplan.type?"table-row":"none"))})}}}function showsupplyinformationDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="panel-heading"><h4 class="panel-title" style="text-transform: capitalize">'+t.getString("supply information")+'</h4></div><div class="table-responsive"><table class="table table-hover table-condensed"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("priority")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("types")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("origin")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("lead time")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("cost")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("size minimum")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("size multiple")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("effective start")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("effective end")+"</b></td></tr></thead><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.attributes.supply.length"],function(a,n){angular.element(document).find("#attributes-supplyinformation").empty().append(r);var o='<tr><td colspan="9">'+t.getString("no supply information")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.attributes.hasOwnProperty("supply")&&(o="",angular.forEach(e.operationplan.attributes.supply,function(e){for(var t in o+="<tr>",e)o+="<td>",o+=e[t],o+="</td>";o+="</tr>"})),angular.element(document).find("#attributes-supplyinformation tbody").append(o)})}}}function showdownstreamoperationplansDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},templateUrl:"/static/operationplandetail/downstreamoperationplans.html",link:function(e,t,a){e.expandOrCollapse=function(t){var a=t+1,n=e.operationplan.downstreamoperationplans[t][0];0==e.operationplan.downstreamoperationplans[t][10]?e.operationplan.downstreamoperationplans[t][10]=1:e.operationplan.downstreamoperationplans[t][10]=0;for(;a<e.operationplan.downstreamoperationplans.length&&!(e.operationplan.downstreamoperationplans[a][0]<=n);)e.operationplan.downstreamoperationplans[a][0]>n+1||0==e.operationplan.downstreamoperationplans[t][10]?e.operationplan.downstreamoperationplans[a][10]=2:a==e.operationplan.downstreamoperationplans.length-1||e.operationplan.downstreamoperationplans[a][0]>=e.operationplan.downstreamoperationplans[a+1][0]?e.operationplan.downstreamoperationplans[a][10]=3:e.operationplan.downstreamoperationplans[a][0]==n+1&&1==e.operationplan.downstreamoperationplans[t][10]&&(e.operationplan.downstreamoperationplans[a][10]=0),++a},e.url_prefix=url_prefix}}}function showupstreamoperationplansDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},templateUrl:"/static/operationplandetail/upstreamoperationplans.html",link:function(e,t,a){e.expandOrCollapse=function(t){var a=t+1,n=e.operationplan.upstreamoperationplans[t][0];0==e.operationplan.upstreamoperationplans[t][10]?e.operationplan.upstreamoperationplans[t][10]=1:e.operationplan.upstreamoperationplans[t][10]=0;for(;a<e.operationplan.upstreamoperationplans.length&&!(e.operationplan.upstreamoperationplans[a][0]<=n);)e.operationplan.upstreamoperationplans[a][0]>n+1||0==e.operationplan.upstreamoperationplans[t][10]?e.operationplan.upstreamoperationplans[a][10]=2:a==e.operationplan.upstreamoperationplans.length-1||e.operationplan.upstreamoperationplans[a][0]>=e.operationplan.upstreamoperationplans[a+1][0]?e.operationplan.upstreamoperationplans[a][10]=3:e.operationplan.upstreamoperationplans[a][0]==n+1&&1==e.operationplan.upstreamoperationplans[t][10]&&(e.operationplan.upstreamoperationplans[a][10]=0),++a},e.url_prefix=url_prefix}}}function showKanbanDrv(e,t,a,n){"use strict";return{restrict:"EA",scope:{operationplan:"=",kanbanoperationplans:"=",kanbancolumns:"=",editable:"="},templateUrl:"/static/operationplandetail/kanban.html",link:function(e,a,r){function o(){switch(e.kanbancolumns.length){case 1:e.colstyle="col-md-12",e.colsum=12;break;case 2:e.colstyle="col-md-6",e.colsum=12;break;case 3:e.colstyle="col-md-4",e.colsum=12;break;case 4:e.colstyle="col-md-3",e.colsum=12;break;case 5:e.colstyle="col-md-3",e.colsum=15;break;case 6:e.colstyle="col-md-2",e.colsum=12;break;case 7:e.colstyle="col-md-2",e.colsum=14;break;case 8:e.colstyle="col-md-2",e.colsum=16;break;default:e.colstyle="col-md-1",e.colsum=e.kanbancolumns.length}e.$parent.colsum=e.colsum}function i(e){e.preventDefault()}function d(t){var a=$(t.target).closest(".column").attr("data-column");if(a){var r=t.originalEvent.dataTransfer.getData("startcolumn"),o=t.originalEvent.dataTransfer.getData("startindex");if("undefined"!==o){var i=$(t.target).closest(".card");i&&(i=i.attr("data-index")),e.$apply(function(){var t=e.kanbanoperationplans[r].rows[o];e.kanbanoperationplans[r].rows.splice(o,1),i?e.kanbanoperationplans[a].rows.splice(i>o&&a==r?i-1:i,0,t):e.kanbanoperationplans[a].rows.unshift(t),e.kanbanoperationplans[r].records--,e.kanbanoperationplans[a].records++,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),t.hasOwnProperty("operationplan__status")?t.hasOwnProperty("operationplan__statusOriginal")?(t.operationplan__statusOriginal==a?(t.dirty=!1,delete t.operationplan__statusOriginal):t.dirty=!0,t.operationplan__status=a,t.status=envalue):t.operationplan__status!=a&&(t.operationplan__statusOriginal=t.operationplan__status,t.operationplan__status=a,t.status=a,t.dirty=!0):t.hasOwnProperty("statusOriginal")?(t.statusOriginal==a?(t.dirty=!1,delete t.statusOriginal):t.dirty=!0,t.status=a):t.status!=a&&(t.statusOriginal=t.status,t.status=a,t.dirty=!0),e.$parent.$broadcast("cardChanged","status",t.statusOriginal,t.status)})}else e.$apply(function(){var t=e.kanbancolumns.indexOf(r),o=e.kanbancolumns.indexOf(a),i=e.kanbancolumns[t];e.kanbancolumns[t]=e.kanbancolumns[o],e.kanbancolumns[o]=i,n.save("columns",e.$parent.kanbancolumns)})}t.preventDefault()}function l(e){e.originalEvent.dataTransfer.setData("startindex",$(e.target).attr("data-index")),e.originalEvent.dataTransfer.setData("startcolumn",$(e.target).closest(".column").attr("data-column")),e.stopPropagation()}function s(){a.on("dragover",".column, .card",i),a.on("drop",".column",d),a.on("dragstart",".column .panel .panel-heading, .card",l)}function p(){a.off("dragover",".column, .card",i),a.off("drop",".column",d),a.off("dragstart",".column .panel .panel-heading, .card",l)}e.curselected=null,e.colstyle="col-md-1",e.colsum=12,e.type="PO",e.admin_escape=admin_escape,e.url_prefix=url_prefix,e.mode=mode,e.opptype={MO:t.getString("Manufacturing Order"),PO:t.getString("Purchase Order"),DO:t.getString("Distribution Order"),STCK:t.getString("Stock"),DLVR:t.getString("Delivery")},o(),e.getHeight=function(e){return preferences&&preferences.height?preferences.height-(e||25):220},e.hideColumn=function(t){var a=e.$parent.kanbancolumns.indexOf(t);e.$parent.kanbancolumns.splice(a,1),o(),n.save("columns",e.$parent.kanbancolumns)},e.grid=grid,e.selectCard=function(t){if(e.curselected){if(e.curselected.reference==t.reference&&t.selected)return;delete e.curselected.selected}t.selected=!0,e.curselected=t,e.$parent.displayInfo(t)},e.$on("selectedEdited",function(t,a,n,r){if(null!==e.curselected){if("loadplans"==a){var o=[];angular.forEach(r,function(e){o.push([e.resource.name,e.quantity])}),e.changeCard(e.curselected,"resource",e.curselected.resource,o),e.curselected.resource=o}else e.changeCard(e.curselected,a,n,r);if("status"===a){var i=e.kanbanoperationplans[n].rows.indexOf(e.curselected);-1!=i&&(e.kanbanoperationplans[n].rows.splice(i,1),e.kanbanoperationplans[r].rows.unshift(e.curselected),e.kanbanoperationplans[n].records--,e.kanbanoperationplans[r].records++)}"loadplans"!=a&&(e.curselected.hasOwnProperty("operationplan__"+a)?e.curselected["operationplan__"+a]=r:e.curselected[a]=r)}}),e.changeCard=function(t,a,n,r){t.hasOwnProperty(a+"Original")||(t[a+"Original"]=n),t.dirty=!0,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),void 0!==r&&e.$parent.$broadcast("cardChanged",a,n,r)},e.enableDragDrop=s,e.disableDragDrop=p,e.$on("changeMode",function(t,a){e.mode=a,e.editable&&"kanban"==a?s():p()}),e.editable&&"kanban"==mode&&s()}}}operationplandetailapp.config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",e.defaults.xsrfCookieName="csrftoken",e.defaults.xsrfHeaderName="X-CSRFToken"}]),operationplandetailapp.run(["gettextCatalog",function(e){e.setCurrentLanguage(language)}]),operationplandetailapp.filter("formatdate",function(){return function(e){return moment.isMoment(e)?e.format(dateformat):e&&void 0!==e?moment(e,datetimeformat).format(dateformat):void 0}}),operationplandetailapp.filter("formatdatetime",function(){return function(e){return moment.isMoment(e)?e.format(datetimeformat):e&&void 0!==e?moment(e,datetimeformat).format(datetimeformat):void 0}}),angular.module("operationplandetailapp").controller("operationplandetailCtrl",operationplanCtrl),operationplanCtrl.$inject=["$scope","$http","OperationPlan","PreferenceSvc"],angular.module("operationplandetailapp").directive("showproblemspanelDrv",showproblemspanelDrv),showproblemspanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showresourcespanelDrv",showresourcespanelDrv),showresourcespanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showbufferspanelDrv",showbufferspanelDrv),showbufferspanelDrv.$inject=["$window","gettextCatalog","$filter"],angular.module("operationplandetailapp").directive("showoperationpeggingpanelDrv",showoperationpeggingpanelDrv),showoperationpeggingpanelDrv.$inject=["$window","gettextCatalog","$filter"],angular.module("operationplandetailapp").directive("showoperationplanDrv",showoperationplanDrv),showoperationplanDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showsupplyinformationDrv",showsupplyinformationDrv),showsupplyinformationDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showdownstreamoperationplansDrv",showdownstreamoperationplansDrv),showdownstreamoperationplansDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showupstreamoperationplansDrv",showupstreamoperationplansDrv),showupstreamoperationplansDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showKanbanDrv",showKanbanDrv),showKanbanDrv.$inject=["$window","gettextCatalog","OperationPlan","PreferenceSvc"];
//# sourceMappingURL=frepple-operationplandetail.min.js.map